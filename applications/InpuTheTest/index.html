<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InpuTheTest</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

    <style>
        /* Fullscreen black background */
        body {
            background-color: black;
            color: white;
            font-family: "Rubik", serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-style: normal;
            margin: 50px;
            display: flex;
            justify-content: left;
            align-items: flex-start;
            height: 100vh;
            overflow: hidden;
        }

        /* Restart button */
        #restart-btn {
            font-family: "Rubik", serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-style: normal;
            position: absolute;
            top: 10px;
            right: 10px;
            height: 50px;
            width: 125px;
            border-radius: 50px;
            background-color: transparent;
            color: white;
            border: none;
            padding: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 1;
        }

        #restart-btn:hover {
            background-color: rgb(40, 40, 40);
        }

        #inp {
            opacity: 0;
            position: absolute;
            bottom: 0;
        }

        /* Container for the typewriter effect */
        #typewriter-container {
            display: flex;
            flex-direction: column-reverse; /* New lines appear at the top */
            align-items: flex-start;
            height: calc(60% - 100px);
            overflow-x: hidden;
            overflow-y: auto;
            padding: 20px;
        }

        /* Each line of typed text */
        .typewriter-line {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-start;
            font-size: 2.5rem;
            white-space: nowrap;
            width: 100%; /* Ensure each line takes the full width */
            transition: all 0.3s ease;
            opacity: 1;
        }

        /* Individual characters */
        .typed-char {
            color: white;
            white-space: nowrap;
            margin-right: 5px;
            transition: all 0.2s ease;
            transform: translateY(-20px);
            opacity: 0;
        }
    </style>
</head>
<body>

    <button id="restart-btn">Clean up</button>
    <input type="text" id="inp"></input>
    <div id="typewriter-container"></div>

    <script>
        const typewriterContainer = document.getElementById('typewriter-container');
        const restartBtn = document.getElementById('restart-btn');
        const inpText = document.getElementById('inp');

        // Global AudioContext (to avoid Chrome blocking sound)
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let soundBuffer = null;

        // Preload the typing sound
        fetch('sound/vfx/0.mp3')
            .then(response => response.arrayBuffer())
            .then(data => audioContext.decodeAudioData(data))
            .then(buffer => {
                soundBuffer = buffer;
            })
            .catch(error => console.error('Error loading sound:', error));

            const deletedChars = []; // Store deleted characters for undo functionality

        document.addEventListener('keydown', async function (event) {
            // Prevent all default actions (including shortcuts)
            if (event.ctrlKey || event.altKey || event.metaKey) {
                event.preventDefault();
            }

            // Ensure AudioContext is running (fixes Chrome issue)
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            let key = event.key;
            let deleting = false;

            if (key === 'Backspace') {
                    handleBackspace();
                    deleting = true;
            } else {
                handleKeyRestoration();
                if (key !== 'Dead') {
                    if (key === ' ') {
                        addCharacter('Space');
                    } else if (key) {
                        addCharacter(key);
                    }
                }
            }

            playTypeSound(deleting);
            selectInp();
        });

        // Ensure the hidden input is always selected
        function selectInp() {
            inpText.focus();
        }

        // Handle input event to capture characters from dead keys
        const deadKeyChars = ['~', '^', 'Â´', '`', '"'];
        inpText.addEventListener('input', () => {
            const char = inpText.value[0] || '';;
            inpText.value = '';

            // Only add the character if it is a recognized dead key
            if (deadKeyChars.includes(char)) {
                addCharacter(char);
            }
        });

        function createNewLine() {
            const newLine = document.createElement('div');
            newLine.classList.add('typewriter-line');

            typewriterContainer.prepend(newLine); // Adds at the top

            typewriterContainer.scrollTop = 0; // Keep scroll position at the top
            fadeOutOldLines();
        }



        function addCharacter(char) {
            let lines = document.querySelectorAll('.typewriter-line');

            if (lines.length === 0) {
                createNewLine();
                lines = document.querySelectorAll('.typewriter-line');
            }

            let currentLine = lines[0]; // Select the latest line (due to column-reverse)

            const charSpan = document.createElement('span');
            charSpan.classList.add('typed-char');
            charSpan.textContent = char;
            currentLine.appendChild(charSpan);

            // Ensure character appears
            setTimeout(() => {
                charSpan.style.transform = 'translateY(0px)';
                charSpan.style.opacity = 1;
            }, 10);

            // If line overflows, create a new one
            if (currentLine.getBoundingClientRect().width >= document.body.getBoundingClientRect().width - 50) {
                currentLine.removeChild(charSpan);
                createNewLine();
                lines = document.querySelectorAll('.typewriter-line');
                currentLine = lines[0]; // Select latest again
                currentLine.appendChild(charSpan);
            }

            typewriterContainer.scrollTop = typewriterContainer.scrollHeight;
        }

        // Function to fade out characters in lines older than 5
        function fadeOutOldLines() {
            let lines = document.querySelectorAll('.typewriter-line');

            for (let i = 0; i < lines.length; ++i) {
                if (i >= 5 && lines[i].style.opacity !== 1) {
                    
                    setTimeout(() => {
                        lines[i].style.opacity = 0;
                        lines[i].style.transform = 'translateY(-100px)';

                        setTimeout(() => {
                            typewriterContainer.removeChild(lines[i])
                        }, 300)
                    }, 300)
                }
            }
        }


        function handleBackspace() {
            let lines = document.querySelectorAll('.typewriter-line');

            if (lines.length === 0) return;

            // Start checking from the last line and move upwards if needed
            for (let lineIndex = 0; lineIndex < 5; ++lineIndex) {
                let currentLine = lines[lineIndex];
                const characters = currentLine.querySelectorAll('.typed-char');

                for (let i = characters.length - 1; i >= 0; i--) {
                    if (characters[i].style.opacity === "" || characters[i].style.opacity === "1") {
                        characters[i].style.opacity = 0; // Hide it
                        characters[i].style.transform = 'translateY(20px)';
                        deletedChars.push({ element: characters[i], parent: currentLine });
                        return;
                    }
                }

                // If the current line is empty after checking, remove it
                if (characters.length === 0 && lines.length > 1) {
                    typewriterContainer.removeChild(currentLine);
                }
            }
        }



        // Restores deleted characters when a new key is pressed
        function handleKeyRestoration() {
            while (deletedChars.length > 0) {
                const { element, parent } = deletedChars.pop();
                parent.removeChild(element)
            }
        }

        // Play typewriter sound with C chord effect
        let playIndex = 0;

        // C, E, G
        const chordPitches = [5, 6.26, 5.5];
        const chordPitchesDel = [5.5, 4.26, 5];
        
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 0.5;      

        function playTypeSound(del = false) {
            if (!soundBuffer) return; // Don't play if sound isn't loaded

            let chords = chordPitches;
            if (del) { chords = chordPitchesDel } 

            const pitch = chords[playIndex]
            const source = audioContext.createBufferSource();
            source.buffer = soundBuffer;
            source.playbackRate.value = pitch; // Adjust playback speed for pitch shift
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            source.start();

            playIndex++;
            if (playIndex >= chordPitches.length) { playIndex = 0; }
        }

        // Restart button functionality
        restartBtn.addEventListener('click', function () {
            typewriterContainer.innerHTML = '';
        });
    </script>
</body>
</html>
